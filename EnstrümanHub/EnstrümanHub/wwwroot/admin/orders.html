<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SipariÅŸ YÃ¶netimi - Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .table { box-shadow: 0 2px 10px rgba(0,0,0,0.075); }
        .btn-warning, .btn-danger { color: white !important; }
        .table-hover tbody tr:hover { background-color: #f1f1f1; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>SipariÅŸ YÃ¶netimi</h2>
            <a href="/admin/dashboard.html" class="btn btn-secondary">Dashboard'a DÃ¶n</a>
        </div>
        <div class="table-responsive">
            <table class="table table-bordered table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>MÃ¼ÅŸteri AdÄ±</th>
                        <th>Tarih</th>
                        <th>Toplam</th>
                        <th>Durum</th>
                        <th>Ä°ÅŸlemler</th>
                    </tr>
                </thead>
                <tbody id="ordersTableBody">
                    <!-- SipariÅŸler buraya dinamik olarak gelecek -->
                </tbody>
            </table>
        </div>
        <div id="loadingMessage" class="text-center py-5" style="display: none;">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">YÃ¼kleniyor...</span>
            </div>
        </div>
        <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
    </div>

    <!-- SipariÅŸ DÃ¼zenle Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">SipariÅŸ Durumunu DÃ¼zenle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editOrderForm">
                        <input type="hidden" id="editingOrderId">
                        <div class="mb-3">
                            <label for="orderStatus" class="form-label">Yeni Durum</label>
                            <select class="form-control" id="orderStatus" required>
                                <option value="Beklemede">Beklemede</option>
                                <option value="Ä°ÅŸleniyor">Ä°ÅŸleniyor</option>
                                <option value="Kargoda">Kargoda</option>
                                <option value="TamamlandÄ±">TamamlandÄ±</option>
                                <option value="Ä°ptal Edildi">Ä°ptal Edildi</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Durumu GÃ¼ncelle</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Silme Onay ModalÄ± -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="deleteConfirmModalLabel">SipariÅŸi Sil</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            Bu sipariÅŸi kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
            <button type="button" class="btn btn-danger" id="confirmDeleteButton">Evet, Sil</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // LÃœTFEN BU BÄ°LGÄ°LERÄ° KENDÄ° FIREBASE PROJENÄ°ZÄ°N BÄ°LGÄ°LERÄ°YLE DEÄÄ°ÅTÄ°RÄ°N
        const firebaseConfig = {
            apiKey: "AIzaSyAS0-UuWWFNMSvnNGEzY0pdBGxhZLEqjnA",
            authDomain: "enstrumand2.firebaseapp.com",
            projectId: "enstrumand2",
            storageBucket: "enstrumand2.appspot.com",
            messagingSenderId: "983179534658",
            appId: "1:983179534658:web:bdccea5d518c26d8dbe8db"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        const API_URL = '/api/orders';

        const loadingMessage = document.getElementById('loadingMessage');
        const errorMessage = document.getElementById('errorMessage');
        const tbody = document.getElementById('ordersTableBody');
        
        let editOrderModalInstance;
        let deleteConfirmModalInstance;
        
        document.addEventListener('DOMContentLoaded', () => {
             editOrderModalInstance = new bootstrap.Modal(document.getElementById('editOrderModal'));
             deleteConfirmModalInstance = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
             
             // Admin kontrolÃ¼ kaldÄ±rÄ±ldÄ±, doÄŸrudan sipariÅŸleri getir
             fetchOrders(null);

            // Form submit olayÄ±nÄ± dinle
            document.getElementById('editOrderForm').addEventListener('submit', handleUpdateSubmit);
        });

        async function getAuthHeader(user) {
            return {
                'Content-Type': 'application/json'
            };
        }
        
        function displayError(message) {
             errorMessage.textContent = message;
             errorMessage.style.display = 'block';
        }

        async function fetchOrders(user) {
            loadingMessage.style.display = 'block';
            errorMessage.style.display = 'none';
            tbody.innerHTML = '';
            
            const headers = await getAuthHeader(user);
            if (!headers) {
                displayError("Yetkilendirme hatasÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.");
                return;
            }

            try {
                console.log("ğŸš€ GET isteÄŸi gÃ¶nderiliyor:", API_URL);
                const response = await fetch(API_URL, { headers });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Sunucu hatasÄ±: ${response.status} - ${errorText}`);
                }

                const orders = await response.json();
                console.log("âœ… API'den gelen ham veri:", orders);
                console.log("ğŸ“Š Veri tipi:", typeof orders);
                console.log("ğŸ“Š Dizi mi?", Array.isArray(orders));
                console.log("ğŸ“Š Eleman sayÄ±sÄ±:", orders.length);

                if (orders.length === 0) {
                    console.log("â„¹ï¸ SipariÅŸ listesi boÅŸ");
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center">GÃ¶sterilecek sipariÅŸ bulunamadÄ±.</td></tr>';
                } else {
                    console.log("â„¹ï¸ SipariÅŸler listeleniyor...");
                    tbody.innerHTML = ''; // Ã–nce tabloyu temizle
                    orders.forEach((order, index) => {
                        console.log(`ğŸ“ SipariÅŸ #${index + 1}:`, order);
                        const date = new Date(order.date).toLocaleDateString('tr-TR');
                        const total = Number(order.total || 0);
                        console.log(`ğŸ“ SipariÅŸ #${index + 1} - DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ tarih:`, date);
                        console.log(`ğŸ“ SipariÅŸ #${index + 1} - DÃ¶nÃ¼ÅŸtÃ¼rÃ¼lmÃ¼ÅŸ toplam:`, total);
                        
                        tbody.innerHTML += `
                        <tr>
                            <td><code>${order.id}</code></td>
                            <td>${order.customerName || 'N/A'}</td>
                            <td>${date}</td>
                            <td>â‚º${total.toFixed(2)}</td>
                            <td><span class="badge bg-info text-dark">${order.status || 'Beklemede'}</span></td>
                            <td>
                                <button class='btn btn-sm btn-warning' onclick='openEditModal("${order.id}", "${order.status}")'>DÃ¼zenle</button>
                                <button class='btn btn-sm btn-danger' onclick='openDeleteConfirm("${order.id}")'>Sil</button>
                            </td>
                        </tr>`;
                    });
                    console.log("âœ… SipariÅŸler baÅŸarÄ±yla listelendi");
                }
            } catch (error) {
                console.error('âŒ SipariÅŸler yÃ¼klenirken hata oluÅŸtu:', error);
                displayError(`SipariÅŸler yÃ¼klenirken bir hata oluÅŸtu: ${error.message}`);
            } finally {
                loadingMessage.style.display = 'none';
            }
        }

        async function deleteOrder(id) {
            const user = firebase.auth().currentUser;
            const headers = await getAuthHeader(user);
            if (!headers) return displayError("Yetkilendirme hatasÄ±.");
            
            try {
                console.log(`ğŸš€ DELETE isteÄŸi gÃ¶nderiliyor: ${API_URL}/${id}`);
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'DELETE',
                    headers
                });

                if (!response.ok) throw new Error('SipariÅŸ silinemedi.');
                
                deleteConfirmModalInstance.hide();
                await fetchOrders(user);
            } catch (error) {
                console.error('SipariÅŸi silerken hata:', error);
                alert('SipariÅŸ silinirken bir hata oluÅŸtu.');
            }
        }
        
        function openEditModal(id, currentStatus) {
            document.getElementById('editingOrderId').value = id;
            document.getElementById('orderStatus').value = currentStatus || 'Beklemede';
            editOrderModalInstance.show();
        }
        
        function openDeleteConfirm(id) {
            const confirmBtn = document.getElementById('confirmDeleteButton');
            confirmBtn.onclick = () => deleteOrder(id);
            deleteConfirmModalInstance.show();
        }

        async function handleUpdateSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editingOrderId').value;
            const status = document.getElementById('orderStatus').value;
            
            const user = firebase.auth().currentUser;
            const headers = await getAuthHeader(user);
            if (!headers) return displayError("Yetkilendirme hatasÄ±.");

            try {
                console.log(`ğŸš€ PATCH isteÄŸi gÃ¶nderiliyor: ${API_URL}/${id}`);
                const response = await fetch(`${API_URL}/${id}`, {
                    method: 'PATCH', // DÃ¼zeltildi: PUT yerine PATCH
                    headers,
                    body: JSON.stringify({ status: status })
                });

                if (!response.ok) throw new Error('GÃ¼ncelleme baÅŸarÄ±sÄ±z oldu.');
                
                editOrderModalInstance.hide();
                await fetchOrders(user);
            } catch (error) {
                console.error('SipariÅŸ gÃ¼ncellenirken hata:', error);
                alert('SipariÅŸ gÃ¼ncellenirken bir hata oluÅŸtu.');
            }
        }
    </script>
</body>
</html>